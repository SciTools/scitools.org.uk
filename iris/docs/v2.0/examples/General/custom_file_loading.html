
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
        <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Loading a cube from a custom file format &#8212; Iris 2.0.0 documentation</title>
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="Quickplot of a 2d cube on a map" href="global_map.html" />
    <link rel="prev" title="Calculating a custom statistic" href="custom_aggregation.html" />
 
    <META HTTP-EQUIV="CACHE-CONTROL" CONTENT="NO-CACHE">
    <META HTTP-EQUIV="PRAGMA" CONTENT="NO-CACHE"> 

    <link rel="stylesheet" href="../../_static/style.css" type="text/css" />
    <script type="text/javascript" src="https://docs.python.org/2/_static/copybutton.js"></script>

  </head><body>
<div style="background-color: white; text-align: left; padding: 1px 10px 1px 15px">
<p style="margin-left: 15px; font-weight:bolder; letter-spacing:0.1ex;">
<a href="../../index.html"><img src="../../_static/Iris7_1_trim_100.png" width=101 height=100 border="0" style="vertical-align:middle" alt="Logo"/></a>
<span style="font-size: 400%; vertical-align:middle"> Iris 2.0 </span>
</p>

</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="global_map.html" title="Quickplot of a 2d cube on a map"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="custom_aggregation.html" title="Calculating a custom statistic"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">home</a>|&nbsp;</li>
        <li><a href="../index.html">examples</a>|&nbsp;</li>
        <li><a href="../../gallery.html">gallery</a>|&nbsp;</li>
        <li><a href="../../contents.html">contents</a>|&nbsp;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Iris examples</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">General visualisation examples</a> &#187;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="custom_aggregation.html"
                        title="previous chapter">Calculating a custom statistic</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="global_map.html"
                        title="next chapter">Quickplot of a 2d cube on a map</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/examples/General/custom_file_loading.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="loading-a-cube-from-a-custom-file-format">
<span id="general-custom-file-loading"></span><h1>Loading a cube from a custom file format<a class="headerlink" href="#loading-a-cube-from-a-custom-file-format" title="Permalink to this headline">¶</a></h1>
<p>This example shows how a custom text file can be loaded using the standard Iris
load mechanism.</p>
<p>The first stage in the process is to define an Iris <a class="reference internal" href="../../iris/iris/io/format_picker.html#iris.io.format_picker.FormatSpecification" title="iris.io.format_picker.FormatSpecification"><code class="xref py py-class docutils literal notranslate"><span class="pre">FormatSpecification</span></code></a> for the file format. To create a
format specification we need to define the following:</p>
<ul>
<li><p class="first">format_name - Some text that describes the format specification we are
creating</p>
</li>
<li><p class="first">file_element - FileElement object describing the element which identifies
this FormatSpecification.</p>
<p>Possible values are:</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">iris.io.format_picker.MagicNumber(n,</span> <span class="pre">o)</span></code></dt>
<dd><p class="first last">The n bytes from the file at offset o.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">iris.io.format_picker.FileExtension()</span></code></dt>
<dd><p class="first last">The file’s extension.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">iris.io.format_picker.LeadingLine()</span></code></dt>
<dd><p class="first last">The first line of the file.</p>
</dd>
</dl>
</div></blockquote>
</li>
<li><p class="first">file_element_value - The value that the file_element should take if a file
matches this FormatSpecification</p>
</li>
<li><p class="first">handler (optional) - A generator function that will be called when the file
specification has been identified. This function is provided by the user and
provides the means to parse the whole file. If no handler function is
provided, then identification is still possible without any handling.</p>
<p>The handler function must define the following arguments:</p>
<ul class="simple">
<li>list of filenames to process</li>
<li>callback function - An optional function to filter/alter the Iris cubes
returned</li>
</ul>
<p>The handler function must be defined as generator which yields each cube as
they are produced.</p>
</li>
<li><p class="first">priority (optional) - Integer giving a priority for considering this
specification where higher priority means sooner consideration</p>
</li>
</ul>
<p>In the following example, the function <code class="xref py py-func docutils literal notranslate"><span class="pre">load_NAME_III()</span></code> has been defined
to handle the loading of the raw data from the custom file format. This
function is called from <code class="xref py py-func docutils literal notranslate"><span class="pre">NAME_to_cube()</span></code> which uses this data to create and
yield Iris cubes.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">main()</span></code> function the filenames are loaded via the <code class="docutils literal notranslate"><span class="pre">iris.load_cube</span></code>
function which automatically invokes the <code class="docutils literal notranslate"><span class="pre">FormatSpecification</span></code> we defined.
The cube returned from the load function is then used to produce a plot.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Loading a cube from a custom file format</span>
<span class="sd">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>

<span class="sd">This example shows how a custom text file can be loaded using the standard Iris</span>
<span class="sd">load mechanism.</span>

<span class="sd">The first stage in the process is to define an Iris :class:`FormatSpecification</span>
<span class="sd">&lt;iris.io.format_picker.FormatSpecification&gt;` for the file format. To create a</span>
<span class="sd">format specification we need to define the following:</span>

<span class="sd">* format_name - Some text that describes the format specification we are</span>
<span class="sd">  creating</span>
<span class="sd">* file_element - FileElement object describing the element which identifies</span>
<span class="sd">  this FormatSpecification.</span>

<span class="sd">  Possible values are:</span>

<span class="sd">    ``iris.io.format_picker.MagicNumber(n, o)``</span>
<span class="sd">        The n bytes from the file at offset o.</span>

<span class="sd">    ``iris.io.format_picker.FileExtension()``</span>
<span class="sd">        The file&#39;s extension.</span>

<span class="sd">    ``iris.io.format_picker.LeadingLine()``</span>
<span class="sd">        The first line of the file.</span>

<span class="sd">* file_element_value - The value that the file_element should take if a file</span>
<span class="sd">  matches this FormatSpecification</span>
<span class="sd">* handler (optional) - A generator function that will be called when the file</span>
<span class="sd">  specification has been identified. This function is provided by the user and</span>
<span class="sd">  provides the means to parse the whole file. If no handler function is</span>
<span class="sd">  provided, then identification is still possible without any handling.</span>

<span class="sd">  The handler function must define the following arguments:</span>

<span class="sd">  * list of filenames to process</span>
<span class="sd">  * callback function - An optional function to filter/alter the Iris cubes</span>
<span class="sd">    returned</span>

<span class="sd">  The handler function must be defined as generator which yields each cube as</span>
<span class="sd">  they are produced.</span>

<span class="sd">* priority (optional) - Integer giving a priority for considering this</span>
<span class="sd">  specification where higher priority means sooner consideration</span>

<span class="sd">In the following example, the function :func:`load_NAME_III` has been defined</span>
<span class="sd">to handle the loading of the raw data from the custom file format. This</span>
<span class="sd">function is called from :func:`NAME_to_cube` which uses this data to create and</span>
<span class="sd">yield Iris cubes.</span>

<span class="sd">In the ``main()`` function the filenames are loaded via the ``iris.load_cube``</span>
<span class="sd">function which automatically invokes the ``FormatSpecification`` we defined.</span>
<span class="sd">The cube returned from the load function is then used to produce a plot.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">cf_units</span> <span class="kn">import</span> <span class="n">Unit</span><span class="p">,</span> <span class="n">CALENDAR_GREGORIAN</span>

<span class="kn">import</span> <span class="nn">iris</span>
<span class="kn">import</span> <span class="nn">iris.coords</span> <span class="kn">as</span> <span class="nn">icoords</span>
<span class="kn">import</span> <span class="nn">iris.coord_systems</span> <span class="kn">as</span> <span class="nn">icoord_systems</span>
<span class="kn">import</span> <span class="nn">iris.fileformats</span>
<span class="kn">import</span> <span class="nn">iris.io.format_picker</span> <span class="kn">as</span> <span class="nn">format_picker</span>
<span class="kn">import</span> <span class="nn">iris.plot</span> <span class="kn">as</span> <span class="nn">iplt</span>


<span class="n">UTC_format</span> <span class="o">=</span> <span class="s1">&#39;%H%M%Z </span><span class="si">%d</span><span class="s1">/%m/%Y&#39;</span>

<span class="n">FLOAT_HEADERS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;X grid origin&#39;</span><span class="p">,</span> <span class="s1">&#39;Y grid origin&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;X grid resolution&#39;</span><span class="p">,</span> <span class="s1">&#39;Y grid resolution&#39;</span><span class="p">]</span>
<span class="n">INT_HEADERS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;X grid size&#39;</span><span class="p">,</span> <span class="s1">&#39;Y grid size&#39;</span><span class="p">,</span> <span class="s1">&#39;Number of fields&#39;</span><span class="p">]</span>
<span class="n">DATE_HEADERS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Run time&#39;</span><span class="p">,</span> <span class="s1">&#39;Start of release&#39;</span><span class="p">,</span> <span class="s1">&#39;End of release&#39;</span><span class="p">]</span>
<span class="n">COLUMN_NAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;species_category&#39;</span><span class="p">,</span> <span class="s1">&#39;species&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_measure&#39;</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">,</span>
                <span class="s1">&#39;unit&#39;</span><span class="p">,</span> <span class="s1">&#39;z_level&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">load_NAME_III</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads the Met Office&#39;s NAME III grid output files returning headers, column</span>
<span class="sd">    definitions and data arrays as 3 separate lists.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Loading a file gives a generator of lines which can be progressed using</span>
    <span class="c1"># the next() function. This will come in handy as we wish to progress</span>
    <span class="c1"># through the file line by line.</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_handle</span><span class="p">:</span>
        <span class="c1"># Define a dictionary which can hold the header metadata for this file.</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Skip the NAME header of the file which looks something like</span>
        <span class="c1"># &#39;NAME III (version X.X.X)&#39;.</span>
        <span class="nb">next</span><span class="p">(</span><span class="n">file_handle</span><span class="p">)</span>

        <span class="c1"># Read the next 16 lines of header information, putting the form</span>
        <span class="c1"># &quot;header name:    header value&quot; into a dictionary.</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
            <span class="n">header_name</span><span class="p">,</span> <span class="n">header_value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">file_handle</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>

            <span class="c1"># Strip off any spurious space characters in the header name and</span>
            <span class="c1"># value.</span>
            <span class="n">header_name</span> <span class="o">=</span> <span class="n">header_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">header_value</span> <span class="o">=</span> <span class="n">header_value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c1"># Cast some headers into floats or integers if they match a given</span>
            <span class="c1"># header name.</span>
            <span class="k">if</span> <span class="n">header_name</span> <span class="ow">in</span> <span class="n">FLOAT_HEADERS</span><span class="p">:</span>
                <span class="n">header_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header_value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">header_name</span> <span class="ow">in</span> <span class="n">INT_HEADERS</span><span class="p">:</span>
                <span class="n">header_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header_value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">header_name</span> <span class="ow">in</span> <span class="n">DATE_HEADERS</span><span class="p">:</span>
                <span class="c1"># convert the time to python datetimes</span>
                <span class="n">header_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">header_value</span><span class="p">,</span>
                                                          <span class="n">UTC_format</span><span class="p">)</span>

            <span class="n">headers</span><span class="p">[</span><span class="n">header_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">header_value</span>

        <span class="c1"># Skip the next blank line in the file.</span>
        <span class="nb">next</span><span class="p">(</span><span class="n">file_handle</span><span class="p">)</span>

        <span class="c1"># Read the next 7 lines of column definitions.</span>
        <span class="n">column_headings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">column_header_name</span> <span class="ow">in</span> <span class="n">COLUMN_NAMES</span><span class="p">:</span>
            <span class="n">column_headings</span><span class="p">[</span><span class="n">column_header_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">col</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">next</span><span class="p">(</span><span class="n">file_handle</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Convert the time to python datetimes.</span>
        <span class="n">new_time_column_header</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">column_headings</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]):</span>
            <span class="c1"># The first 4 columns aren&#39;t time at all, so don&#39;t convert them to</span>
            <span class="c1"># datetimes.</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">UTC_format</span><span class="p">)</span>
            <span class="n">new_time_column_header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">column_headings</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_time_column_header</span>

        <span class="c1"># Skip the blank line after the column headers.</span>
        <span class="nb">next</span><span class="p">(</span><span class="n">file_handle</span><span class="p">)</span>

        <span class="c1"># Make a list of data arrays to hold the data for each column.</span>
        <span class="n">data_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Y grid size&#39;</span><span class="p">],</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X grid size&#39;</span><span class="p">])</span>
        <span class="n">data_arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Number of fields&#39;</span><span class="p">])]</span>

        <span class="c1"># Iterate over the remaining lines which represent the data in a column</span>
        <span class="c1"># form.</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file_handle</span><span class="p">:</span>
            <span class="c1"># Split the line by comma, removing the last empty column caused by</span>
            <span class="c1"># the trailing comma.</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Cast the x and y grid positions to floats and convert them to</span>
            <span class="c1"># zero based indices (the numbers are 1 based grid positions where</span>
            <span class="c1"># 0.5 represents half a grid point.)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mf">1.5</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mf">1.5</span><span class="p">)</span>

            <span class="c1"># Populate the data arrays (i.e. all columns but the leading 4).</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data_array</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_arrays</span><span class="p">):</span>
                <span class="n">data_array</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">headers</span><span class="p">,</span> <span class="n">column_headings</span><span class="p">,</span> <span class="n">data_arrays</span>


<span class="k">def</span> <span class="nf">NAME_to_cube</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a generator of cubes given a list of filenames and a callback.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
        <span class="n">header</span><span class="p">,</span> <span class="n">column_headings</span><span class="p">,</span> <span class="n">data_arrays</span> <span class="o">=</span> <span class="n">load_NAME_III</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data_array</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_arrays</span><span class="p">):</span>
            <span class="c1"># turn the dictionary of column headers with a list of header</span>
            <span class="c1"># information for each field into a dictionary of headers for just</span>
            <span class="c1"># this field. Ignore the first 4 columns of grid position (data was</span>
            <span class="c1"># located with the data array).</span>
            <span class="n">field_headings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">])</span>
                                  <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">column_headings</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

            <span class="c1"># make an cube</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">Cube</span><span class="p">(</span><span class="n">data_array</span><span class="p">)</span>

            <span class="c1"># define the name and unit</span>
            <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field_headings</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">],</span>
                               <span class="n">field_headings</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]))</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">cube</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="c1"># Some units are badly encoded in the file, fix this by putting a</span>
            <span class="c1"># space in between. (if gs is not found, then the string will be</span>
            <span class="c1"># returned unchanged)</span>
            <span class="n">cube</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">field_headings</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;gs&#39;</span><span class="p">,</span> <span class="s1">&#39;g s&#39;</span><span class="p">)</span>

            <span class="c1"># define and add the singular coordinates of the field (flight</span>
            <span class="c1"># level, time etc.)</span>
            <span class="n">cube</span><span class="o">.</span><span class="n">add_aux_coord</span><span class="p">(</span><span class="n">icoords</span><span class="o">.</span><span class="n">AuxCoord</span><span class="p">(</span><span class="n">field_headings</span><span class="p">[</span><span class="s1">&#39;z_level&#39;</span><span class="p">],</span>
                                                <span class="n">long_name</span><span class="o">=</span><span class="s1">&#39;flight_level&#39;</span><span class="p">,</span>
                                                <span class="n">units</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">))</span>

            <span class="c1"># define the time unit and use it to serialise the datetime for the</span>
            <span class="c1"># time coordinate</span>
            <span class="n">time_unit</span> <span class="o">=</span> <span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;hours since epoch&#39;</span><span class="p">,</span> <span class="n">calendar</span><span class="o">=</span><span class="n">CALENDAR_GREGORIAN</span><span class="p">)</span>
            <span class="n">time_coord</span> <span class="o">=</span> <span class="n">icoords</span><span class="o">.</span><span class="n">AuxCoord</span><span class="p">(</span>
                <span class="n">time_unit</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">field_headings</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]),</span>
                <span class="n">standard_name</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span>
                <span class="n">units</span><span class="o">=</span><span class="n">time_unit</span><span class="p">)</span>
            <span class="n">cube</span><span class="o">.</span><span class="n">add_aux_coord</span><span class="p">(</span><span class="n">time_coord</span><span class="p">)</span>

            <span class="c1"># build a coordinate system which can be referenced by latitude and</span>
            <span class="c1"># longitude coordinates</span>
            <span class="n">lat_lon_coord_system</span> <span class="o">=</span> <span class="n">icoord_systems</span><span class="o">.</span><span class="n">GeogCS</span><span class="p">(</span><span class="mi">6371229</span><span class="p">)</span>

            <span class="c1"># build regular latitude and longitude coordinates which have</span>
            <span class="c1"># bounds</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;X grid origin&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;X grid resolution&#39;</span><span class="p">]</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;X grid resolution&#39;</span><span class="p">]</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;X grid size&#39;</span><span class="p">]</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span>
            <span class="n">lon_coord</span> <span class="o">=</span> <span class="n">icoords</span><span class="o">.</span><span class="n">DimCoord</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">standard_name</span><span class="o">=</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span>
                                         <span class="n">units</span><span class="o">=</span><span class="s1">&#39;degrees&#39;</span><span class="p">,</span>
                                         <span class="n">coord_system</span><span class="o">=</span><span class="n">lat_lon_coord_system</span><span class="p">)</span>
            <span class="n">lon_coord</span><span class="o">.</span><span class="n">guess_bounds</span><span class="p">()</span>

            <span class="n">start</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Y grid origin&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Y grid resolution&#39;</span><span class="p">]</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Y grid resolution&#39;</span><span class="p">]</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Y grid size&#39;</span><span class="p">]</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span>
            <span class="n">lat_coord</span> <span class="o">=</span> <span class="n">icoords</span><span class="o">.</span><span class="n">DimCoord</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">standard_name</span><span class="o">=</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span>
                                         <span class="n">units</span><span class="o">=</span><span class="s1">&#39;degrees&#39;</span><span class="p">,</span>
                                         <span class="n">coord_system</span><span class="o">=</span><span class="n">lat_lon_coord_system</span><span class="p">)</span>
            <span class="n">lat_coord</span><span class="o">.</span><span class="n">guess_bounds</span><span class="p">()</span>

            <span class="c1"># add the latitude and longitude coordinates to the cube, with</span>
            <span class="c1"># mappings to data dimensions</span>
            <span class="n">cube</span><span class="o">.</span><span class="n">add_dim_coord</span><span class="p">(</span><span class="n">lat_coord</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">cube</span><span class="o">.</span><span class="n">add_dim_coord</span><span class="p">(</span><span class="n">lon_coord</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># implement standard iris callback capability. Although callbacks</span>
            <span class="c1"># are not used in this example, the standard mechanism for a custom</span>
            <span class="c1"># loader to implement a callback is shown:</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">run_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">cube</span><span class="p">,</span>
                                        <span class="p">[</span><span class="n">header</span><span class="p">,</span> <span class="n">field_headings</span><span class="p">,</span> <span class="n">data_array</span><span class="p">],</span>
                                        <span class="n">filename</span><span class="p">)</span>

            <span class="c1"># yield the cube created (the loop will continue when the next()</span>
            <span class="c1"># element is requested)</span>
            <span class="k">yield</span> <span class="n">cube</span>


<span class="c1"># Create a format_picker specification of the NAME file format giving it a</span>
<span class="c1"># priority greater than the built in NAME loader.</span>
<span class="n">_NAME_III_spec</span> <span class="o">=</span> <span class="n">format_picker</span><span class="o">.</span><span class="n">FormatSpecification</span><span class="p">(</span>
    <span class="s1">&#39;Name III&#39;</span><span class="p">,</span>
    <span class="n">format_picker</span><span class="o">.</span><span class="n">LeadingLine</span><span class="p">(),</span>
    <span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;NAME III&quot;</span><span class="p">),</span>
    <span class="n">NAME_to_cube</span><span class="p">,</span>
    <span class="n">priority</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

<span class="c1"># Register the NAME loader with iris</span>
<span class="n">iris</span><span class="o">.</span><span class="n">fileformats</span><span class="o">.</span><span class="n">FORMAT_AGENT</span><span class="o">.</span><span class="n">add_spec</span><span class="p">(</span><span class="n">_NAME_III_spec</span><span class="p">)</span>


<span class="c1"># ---------------------------------------------</span>
<span class="c1"># |          Using the new loader             |</span>
<span class="c1"># ---------------------------------------------</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">sample_data_path</span><span class="p">(</span><span class="s1">&#39;NAME_output.txt&#39;</span><span class="p">)</span>

    <span class="n">boundary_volc_ash_constraint</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
        <span class="s1">&#39;VOLCANIC_ASH_AIR_CONCENTRATION&#39;</span><span class="p">,</span>
        <span class="n">flight_level</span><span class="o">=</span><span class="s1">&#39;From FL000 - FL200&#39;</span><span class="p">)</span>

    <span class="c1"># Callback shown as None to illustrate where a cube-level callback function</span>
    <span class="c1"># would be used if required</span>
    <span class="n">cube</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">load_cube</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">boundary_volc_ash_constraint</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

    <span class="c1"># draw contour levels for the data (the top level is just a catch-all)</span>
    <span class="n">levels</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0002</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">,</span> <span class="mf">0.004</span><span class="p">,</span> <span class="mf">1e10</span><span class="p">)</span>
    <span class="n">cs</span> <span class="o">=</span> <span class="n">iplt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
                       <span class="n">colors</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;#80ffff&#39;</span><span class="p">,</span> <span class="s1">&#39;#939598&#39;</span><span class="p">,</span> <span class="s1">&#39;#e00404&#39;</span><span class="p">),</span>
                       <span class="p">)</span>

    <span class="c1"># draw a black outline at the lowest contour to highlight affected areas</span>
    <span class="n">iplt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">(</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">100</span><span class="p">),</span>
                 <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

    <span class="c1"># set an extent and a background image for the map</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">((</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">75</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">stock_img</span><span class="p">(</span><span class="s1">&#39;ne_shaded&#39;</span><span class="p">)</span>

    <span class="c1"># make a legend, with custom labels, for the coloured contour set</span>
    <span class="n">artists</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">legend_elements</span><span class="p">()</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">r</span><span class="s1">&#39;$</span><span class="si">%s</span><span class="s1"> &lt; x \leq </span><span class="si">%s</span><span class="s1">$&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">levels</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="sa">r</span><span class="s1">&#39;$</span><span class="si">%s</span><span class="s1"> &lt; x \leq </span><span class="si">%s</span><span class="s1">$&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">levels</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">levels</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
        <span class="sa">r</span><span class="s1">&#39;$x &gt; </span><span class="si">%s</span><span class="s1">$&#39;</span> <span class="o">%</span> <span class="n">levels</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">artists</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Ash concentration / g m-3&#39;</span><span class="p">,</span>
              <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

    <span class="n">time</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="n">time_date</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">UTC_format</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Volcanic ash concentration forecast</span><span class="se">\n</span><span class="s1">valid at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">time_date</span><span class="p">)</span>

    <span class="n">iplt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>(<a class="reference external" href="../../examples/General/custom_file_loading.py">Source code</a>, <a class="reference external" href="../../examples/General/custom_file_loading.png">png</a>)</p>
<div class="figure" id="custom-file-loading">
<img alt="../../_images/custom_file_loading.png" src="../../_images/custom_file_loading.png" />
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="global_map.html" title="Quickplot of a 2d cube on a map"
             >next</a> |</li>
        <li class="right" >
          <a href="custom_aggregation.html" title="Calculating a custom statistic"
             >previous</a> |</li>
        <li><a href="../../index.html">home</a>|&nbsp;</li>
        <li><a href="../index.html">examples</a>|&nbsp;</li>
        <li><a href="../../gallery.html">gallery</a>|&nbsp;</li>
        <li><a href="../../contents.html">contents</a>|&nbsp;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Iris examples</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >General visualisation examples</a> &#187;</li> 
      </ul>
    </div>

    <div class="footer">
    <p style="text-align: left; float: left; margin: 0px; padding: 0 0 0 5px;">Documentation licensed under the <a href="http://reference.data.gov.uk/id/open-government-licence" rel="license">Open Government Licence</a></p>
        &copy; <a href="../../copyright.html">British Crown Copyright</a> 2010 - 2018, Met Office
    </div>


  <!-- Include a version switcher to easily move between the documentation of different versions -->
  <script type=text/javascript src=/iris/docs/version_switch.js></script>
  </body>
</html>